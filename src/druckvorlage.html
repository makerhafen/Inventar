<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <style>

        .eurobox1 { height:285px; width: 1600px; border:1px solid black; position: absolute; }
        .eurobox2 { height:400px; width: 1600px; border:1px solid black; position: absolute; }
        .eurobox3 { height:600px; width: 1600px; border:1px solid black; position: absolute; }
    </style>
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://unpkg.com/konva@7.2.2/konva.min.js"></script>
</head>
<body>
<div></div>
    <div>
        Select Location by ID
        <input id="selector" type="text" onchange="show_lager(this.value)"/>
        <button onclick="imageViewer.save()">save</button>
        <button onclick="imageViewer.printview()">printview</button>
    </div>
    <div id="eurobox1" class="eurobox1" style="display:none"></div>
    <div id="eurobox2" class="eurobox2" style="display:none"></div>
    <div id="eurobox3" class="eurobox3" style="display:none"></div>
    <div id="target"></div>


    <div id="container"></div>
    <script>

    let imageViewer = undefined;
    function show_lager(id) {
        show_lagerid_template(id);
        document.getElementById("container").innerHTML = "";
        imageViewer = new ImageViewer("container", 1600, 200)

        let cnt = 0;
        let images = [];
        for (var Index = 0; Index < inventory.length; Index++) {
            //id, name, kategorie, image,location, url
            let location = inventory[Index][3]
            if(location == id){
                let image = inventory[Index][4].split("(")[1].split(")")[0];
                images.push(image);
                cnt += 1;
                if(cnt > 22){
                    break;
                }
            }
        }

        while(images.length > 0){
            index =  Math.floor(Math.random() * images.length);
            imageViewer.add_image("../" + images[index].replace("/raw/","/processed/").replace("jpg","png"));
            images.splice(index,1);
        }
    }

    function show_lagerid_template(id) {
        for (var Index = 0; Index < storage.length; Index++) {
            //console.log(storage[Index]);
             if(storage[Index][0] == id){
                type = storage[Index][1];
                document.getElementById(type).style.display = "block";
                document.getElementById("target").innerHTML = "";
                document.getElementById("target").appendChild (document.getElementById(type).cloneNode(true));
                document.getElementById(type).style.display = "none";
                break;
            }
        }
    }


    function ImageViewer(container, width, height){
        var self = this;
        self.container = container;
        self.width = width;
        self.height = height;

        self.stage = new Konva.Stage({ container: self.container, width:  window.innerWidth,height: window.innerHeight, });
        self.layer = new Konva.Layer();
        self.stage.add(self.layer);
        self.images = [];
        self.transformers = [];
        self.is_printview = false;

        self.printview = function(){
            for (var Index = 0; Index < self.transformers.length; Index++) {
                if( self.is_printview == true){
                    self.transformers[Index].setAnchorStroke("#ffaa33cc")
                }else{
                    self.transformers[Index].setAnchorStroke("#ff000000")
                }

            }
            self.is_printview = ! self.is_printview;

        }
        self.save = function(){
            for (var Index = 0; Index < self.images.length; Index++) {
                let w = self.images[Index].getWidth();
                let h = self.images[Index].getHeight();
                let p = self.images[Index].getPosition();
                console.log(w,h,p )
            }
        }

        self.add_image = function(image_url){
            console.log(image);
            var image = new Konva.Image({ draggable: true,});
            self.layer.add(image);
            //anchorStroke: "#ff000000"
            //
            var transformer = new Konva.Transformer({ nodes: [image],anchorFill: "#ff000000", anchorStroke: "#ffaa33cc",keepRatio: true, borderEnabled: false, anchorSize: 15, enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right',] });
            self.transformers.push(transformer)
            self.layer.add(transformer);
            self.layer.draw();
            var image_obj = new Image();
            image_obj.onload = function () {
                image.image(image_obj);
                new_width = 200;
                factor = image.getWidth() / new_width
                image.setWidth(new_width);
                image.setHeight(image.getHeight() / factor);
                self.images.push(image);
                self.layer.draw();
            };
            image_obj.src = image_url;
        }
    }



    let inventory = [];
    let storage = [];
    function load_inventory(markdown) {
        var lines = markdown.split("\n");
        var start_found = false;
        for (var Index = 1; Index < lines.length; Index++) {
            if(lines[Index].indexOf("----------------------") != -1){start_found = true;continue;}
            if(start_found == false){continue;};
            parts = lines[Index].split("|");
            if(parts.length < 5){continue;}
            let id = parts[1].trim();
            if (id==""){continue};
            let name = parts[2].trim();
            let kategorie = parts[3].trim();
            let image = parts[4].trim();
            let location = parts[5].trim();
            let url = parts[6].trim();
            //console.log(id, name, kategorie, image,location, url);
            inventory.push([id, name, kategorie, image,location, url])
        }
    }

    function load_storage(markdown) {
        var lines = markdown.split("\n");
        var start_found = false;
        for (var Index = 1; Index < lines.length; Index++) {
            if(lines[Index].indexOf("---------------") != -1){start_found = true;continue;}
            if(start_found == false){continue;};
            parts = lines[Index].split("|");
            if(parts.length < 2){continue;}
            let id = parts[1].trim();
            if (id==""){continue};
            let type = parts[2].trim();
            let description = parts[3].trim();
            //console.log(id, type,description )
            storage.push([id, type,description]);
        }
    }

    $.ajax({ async: false, url:"../InventarListe.md",success: function (data){ load_inventory(data); } });
    $.ajax({ async: false, url:"../LagerVerzeichnis.md",success: function (data){ load_storage(data); } });


    </script>


</body>
</html>

