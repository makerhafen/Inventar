<!DOCTYPE html>
<html>
<head>
<script src="https://unpkg.com/konva@7.2.2/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Image Resize Demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
    <style>

        .eurobox1 { height:200px; width: 1080px; border:1px solid black; position: absolute; }
        .eurobox2 { height:400px; width: 1080px; border:1px solid black; position: absolute; }
        .eurobox3 { height:600px; width: 1080px; border:1px solid black; position: absolute; }
        .width1 { max-width: 12.5%;  width: auto; height: auto !important; }
        .width2 { max-width: 25.0%;  width: auto; height: auto !important; }
        .width3 { max-width: 37.5%;  width: auto; height: auto !important; }
        .width4 { max-width: 50.0%;  width: auto; height: auto !important; }
        .eurobox1 > .row1  { bottom: 0% !important; height:50%}
        .eurobox1 > .row2  { bottom:50% !important; height:50%}
        .eurobox2 > .row1  { bottom: 0% !important; height:33%}
        .eurobox2 > .row2  { bottom:33% !important; height:33%}
        .eurobox2 > .row3  { bottom:66% !important; height:33%}
        .eurobox3 > .row1  { bottom: 0% !important; height:25%}
        .eurobox3 > .row2  { bottom:25% !important; height:25%}
        .eurobox3 > .row3  { bottom:50% !important; height:25%}
        .eurobox3 > .row4  { bottom:75% !important; height:25%}
        .col1 { position: absolute; left: 00.0%; }
        .col2 { position: absolute; left: 12.5%; }
        .col3 { position: absolute; left: 25.0%; }
        .col4 { position: absolute; left: 37.5%; }
        .col5 { position: absolute; left: 50.0%; }
        .col6 { position: absolute; left: 62.5%; }
        .col7 { position: absolute; left: 75.0%; }
        .col8 { position: absolute; left: 87.5%; }
    </style>
        <script src="https://code.jquery.com/jquery-latest.js"></script>

<script>
function Node(parent, width, height){
    var self = this;
    self.parent = parent;
    self.width = width;
    self.height = height;
    self.image = undefined;
    self.children = undefined;
    self.subnode_cnt = 0;
    self.max_children = 2 ; Math.floor(width/height) +1
    if ( self.max_children < 2){  self.max_children = 2;}
    self.position_top = function(){
        if(self.parent != undefined){
            return self.parent.position_top() + (  self.parent.height );
        }else{
            return 0;
        }
    }
    self.position_left = function(){
        if(self.parent != undefined){
            return self.parent.position_left() + ( self.parent.width - self.width );
        }else{
            return 0;
        }
    }

    self.get_dom_element = function(){
        let domDiv = document.createElement("div");
        if(self.parent == undefined){
            domDiv.style.border = "1px solid gray";
        }
        domDiv.style.textAlign =  "center";
        domDiv.style.float =  "left";
        domDiv.style.width =  self.width + "px";
        domDiv.style.height = self.height + "px";
        if(self.image != undefined){
            let domImg = document.createElement("img");
            domImg.src = self.image;
            domImg.style.maxWidth = self.width + "px";
            domImg.style.maxHeight = self.height + "px";
            domDiv.appendChild(domImg);
         }else{
            for (var Index = 0; Index < self.children.length; Index++) {
                domDiv.appendChild(self.children[Index].get_dom_element());
            }
         }
         return domDiv;
    }


    self.print = function(space = ""){
        console.log(space + "Node: " + self.image + "  "  + self.width + ":" + self.height )
        if( self.children != undefined){
            for (var Index = 0; Index < self.children.length; Index++) {
                self.children[Index].print(space + "  ")
            }
        }
        if(self.image != undefined){
            let domDiv = document.createElement("div");
            domDiv.style.width =  self.width + "px";
            domDiv.style.height = self.height + "px";
            domDiv.style.position = "absolute";
            domDiv.style.top = self.position_top() + "px";
            domDiv.style.left = self.position_left() + "px";

            let domImg = document.createElement("img");
            domImg.src = self.image;
            domImg.style.maxHeight = self.height + "px";
            domImg.style.maxWidth = self.width + "px";
            domDiv.appendChild(domImg);
            document.getElementById("target").appendChild ( domDiv );
        }


    }

    self.add = function(image){
        self.subnode_cnt += 1;
        console.log("add image", image);
        if(self.image == undefined && self.children == undefined){
            self.image = image;
        }else{
            let new_width = width;
            let new_height = height;
            if (new_width/ new_height  > 1.1){
                new_width = new_width/2;
            }else{
                new_height = new_height/2;
            }
            if(self.children == undefined){
                let n1 = new Node(self, new_width, new_height);
                let n2 = new Node(self, new_width, new_height);
                self.children = [n1, n2];
                self.children[0].add(self.image);
                self.children[1].add(image);
                self.image = undefined;
            }else{
                if(self.children.length >= self.max_children ){
                    if(self.children[0].subnode_cnt == self.children[1].subnode_cnt){
                        if(Math.random() < 0.5){ self.children[0].add(image); }
                        else{                    self.children[1].add(image); }
                    }else{
                        if(self.children[0].subnode_cnt > self.children[1].subnode_cnt){
                             self.children[1].add(image);
                        }else{
                            self.children[0].add(image);
                        }
                    }
                }else{
                    console.log("MAX NODES NOT REACHED")
                    let n1 = new Node(self, new_width, new_height);
                    n1.add(image);
                    self.children.push(n1)
                    for (var Index = 0; Index < self.children.length; Index++) {
                        if (new_width/ new_height > 1.1 ){
                            self.children[Index].width = self.width / self.children.length;
                        }else{
                            self.children[Index].height = self.height / self.children.length;
                        }
                    }
                }

            }
        }
    }
}





























    let inventory = [];
    let storage = [];
    function load_inventory(markdown) {
        var lines = markdown.split("\n");
        var start_found = false;
        for (var Index = 1; Index < lines.length; Index++) {
            if(lines[Index].indexOf("----------------------") != -1){start_found = true;continue;}
            if(start_found == false){continue;};
            parts = lines[Index].split("|");
            if(parts.length < 5){continue;}
            let id = parts[1].trim();
            if (id==""){continue};
            let name = parts[2].trim();
            let kategorie = parts[3].trim();
            let image = parts[4].trim();
            let location = parts[5].trim();
            let url = parts[6].trim();
            //console.log(id, name, kategorie, image,location, url);
            inventory.push([id, name, kategorie, image,location, url])
        }
    }

    function load_storage(markdown) {
        var lines = markdown.split("\n");
        var start_found = false;
        for (var Index = 1; Index < lines.length; Index++) {
            if(lines[Index].indexOf("---------------") != -1){start_found = true;continue;}
            if(start_found == false){continue;};
            parts = lines[Index].split("|");
            if(parts.length < 2){continue;}
            let id = parts[1].trim();
            if (id==""){continue};
            let type = parts[2].trim();
            let description = parts[3].trim();
            //console.log(id, type,description )
            storage.push([id, type,description]);
        }
    }


    function show_storage(id) {
        for (var Index = 0; Index < storage.length; Index++) {
            //console.log(storage[Index]);
             if(storage[Index][0] == id){
                type = storage[Index][1];
                show_template(type);
                break;
            }
        }
        let cnt = 0;
        for (var Index = 0; Index < inventory.length; Index++) {
            //id, name, kategorie, image,location, url
            let location = inventory[Index][4]
            if(location == id){
                let image = inventory[Index][3].split("(")[1].split(")")[0];
                domImg = document.createElement("img");
                domImg.src = image;
                domImg.classList.add("width1");
                domImg.classList.add("row" + (Math.floor(cnt/8)+1));
                domImg.classList.add("col" + ((cnt%8)+1));
                document.getElementById("target").firstChild.appendChild(domImg);
                //console.log(inventory[Index])
                cnt += 1;
                root_node.add(image);
            }
        }

    }


    function print(id) {
        root_node = new Node(undefined, 1350,250);
        let cnt = 0;
        let images = [];
        for (var Index = 0; Index < inventory.length; Index++) {
            //id, name, kategorie, image,location, url
            let location = inventory[Index][4]
            if(location == id){
                let image = inventory[Index][3].split("(")[1].split(")")[0];
                images.push(image);
                cnt += 1;
                if(cnt > 22){
                    break;
                }
            }
        }

        while(images.length > 0){
            index =  Math.floor(Math.random() * images.length);
            root_node.add(images[index].replace("/raw/","/processed/").replace("jpg","png"));
            images.splice(index,1);
        }



        document.getElementById("target").innerHTML = "";
        document.getElementById("target").appendChild (root_node.get_dom_element());
    }


    function show_template(name) {
        document.getElementById(name).style.display = "block";
        document.getElementById("target").innerHTML = "";
        document.getElementById("target").appendChild (document.getElementById(name).cloneNode(true));
        document.getElementById(name).style.display = "none";
    }


    $.ajax({ async: false, url:"README.md",success: function (data){ load_inventory(data); } });
    $.ajax({ async: false, url:"storage.md",success: function (data){ load_storage(data); } });




</script>
</head>
<body>
<div></div>
    <div>
        Select Location
        <select id="comboA" onchange="show_template(this.value)">
          <option value="">Select combo</option>
          <option value="eurobox1">eurobox1</option>
          <option value="eurobox2">eurobox2</option>
          <option value="eurobox3">eurobox3</option>
        </select>
        <select id="comboB" onchange="show_storage(this.value)">
          <option value="">Select combo</option>
          <option value="K1">K1</option>
          <option value="K2">K2</option>
        </select>
        <select id="comboC" onchange="print(this.value)">
          <option value="">Select combo</option>
          <option value="K1">K1</option>
          <option value="K2">K2</option>
        </select>
    </div>
    <div id="eurobox1" class="eurobox1" style="display:none">
        <div class="width1 row1 col1">row 1</div>
        <div class="width1 row2 col1">row 2, col 1</div>
        <div class="width1 row2 col2">col 2</div>
        <div class="width1 row2 col3">col 3</div>
        <div class="width1 row2 col4">col 4</div>
        <div class="width1 row2 col5">col 5</div>
        <div class="width1 row2 col6">col 6</div>
        <div class="width1 row2 col7">col 7</div>
        <div class="width1 row2 col8">col 8</div>
    </div>
    <div id="eurobox2" class="eurobox2" style="display:none">
        <div class="width1 row1 col1">row 1</div>
        <div class="width1 row2 col1">row 2</div>
        <div class="width1 row4 col1">row 3, col 1</div>
        <div class="width1 row4 col2">col 2</div>
        <div class="width1 row4 col3">col 3</div>
        <div class="width1 row4 col4">col 4</div>
        <div class="width1 row4 col5">col 5</div>
        <div class="width1 row4 col6">col 6</div>
        <div class="width1 row4 col7">col 7</div>
        <div class="width1 row4 col8">col 8</div>
    </div>
    <div id="eurobox3" class="eurobox3" style="display:none">
        <div class="width1 row1 col1">row 1</div>
        <div class="width1 row2 col1">row 2</div>
        <div class="width1 row3 col1">row 3</div>
        <div class="width1 row4 col1">row 4, col 1</div>
        <div class="width1 row4 col2">col 2</div>
        <div class="width1 row4 col3">col 3</div>
        <div class="width1 row4 col4">col 4</div>
        <div class="width1 row4 col5">col 5</div>
        <div class="width1 row4 col6">col 6</div>
        <div class="width1 row4 col7">col 7</div>
        <div class="width1 row4 col8">col 8</div>
    </div>
    <div id="target">

    </div>


    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height,
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      var text1 = new Konva.Text({
        x: 50,
        y: 70,
        fontSize: 30,
        text: 'keepRatio = truetest\ntest',
        draggable: true,
      });
      layer.add(text1);

      var tr1 = new Konva.Transformer({
        nodes: [text1],
        keepRatio: true,
        borderEnabled: false,
        anchorSize: 15,
        anchorStroke: "#ff000000",
        anchorFill: "#ff000000",
        enabledAnchors: [
          'top-left',
          'top-right',
          'bottom-left',
          'bottom-right',
        ],
      });
      layer.add(tr1);

      var text2 = new Konva.Text({
        x: 50,
        y: 200,
        fontSize: 30,
        text: 'keepRatio = false',
        draggable: true,
      });
      var image_1 = new Konva.Image({
        //width: 93,
        //height: 104,
        draggable: true,
      });



      layer.add(image_1);

      var tr2 = new Konva.Transformer({
        nodes: [image_1],
        keepRatio: true,
        enabledAnchors: [
          'top-left',
          'top-right',
          'bottom-left',
          'bottom-right',
        ],
      });
      tr2
      layer.add(tr2);

      layer.draw();

      var imageObj1 = new Image();
      imageObj1.onload = function () {
        image_1.image(imageObj1);
        old_width = image_1.getWidth();
        old_height = image_1.getHeight();
        console.log(old_width, old_height);
        new_width = 100;
        factor = old_width / new_width
        new_height =  old_height / factor
        console.log(factor, new_height);
        image_1.setWidth(new_width);
        image_1.setHeight(new_height);
        layer.draw();
      };
      imageObj1.src = 'images/processed/1.png';

    </script>


</body>
</html>

